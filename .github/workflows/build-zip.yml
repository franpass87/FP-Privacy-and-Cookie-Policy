name: Build plugin ZIP

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Ref opzionale (branch/tag) da buildare'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      slug: ${{ steps.meta.outputs.slug }}
      zip_name: ${{ steps.pkg.outputs.zip_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Setup PHP (solo per lint)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: none
          coverage: none

      - name: Determina slug, file principale e versione (auto-detect)
        id: meta
        run: |
          set -euo pipefail
          PLUGIN_SLUG="fp-privacy-cookie-policy"

          # Cerca il main file ovunque (matching header "Plugin Name: FP Privacy and Cookie Policy")
          MAIN_FILE="$(grep -RIl --exclude-dir=.git --include="*.php" -e "^.*Plugin Name:[[:space:]]*FP Privacy and Cookie Policy" . | head -n1 || true)"
          if [ -z "${MAIN_FILE}" ]; then
            echo "Main file non trovato: cerca l'header 'Plugin Name: FP Privacy and Cookie Policy'." >&2
            exit 1
          fi

          # Cartella radice del plugin (dir del main file)
          PLUGIN_DIR="$(dirname "${MAIN_FILE}")"

          # Estrai Version: dall'header
          VERSION="$(grep -E '^[[:space:]]*\*?[[:space:]]*Version:[[:space:]]*' "${MAIN_FILE}" | head -n1 | sed -E 's/.*Version:[[:space:]]*//; s/[[:space:]]+$//')"
          if [ -z "${VERSION}" ]; then
            echo "Version non trovata nell'header di ${MAIN_FILE}" >&2
            exit 1
          fi

          echo "slug=${PLUGIN_SLUG}"        >> "$GITHUB_OUTPUT"
          echo "main=${MAIN_FILE}"          >> "$GITHUB_OUTPUT"
          echo "plugin_dir=${PLUGIN_DIR}"   >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}"         >> "$GITHUB_OUTPUT"

      - name: Verifica corrispondenza tag â‡” Version (se evento tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF##*/}"
          VERSION="${{ steps.meta.outputs.version }}"
          TAG_VER="${TAG#v}"
          if [ "$TAG_VER" != "$VERSION" ]; then
            echo "ERRORE: il tag ($TAG) non corrisponde alla Version ($VERSION) nell'header del plugin." >&2
            exit 1
          fi
          echo "OK: tag ($TAG) combacia con Version ($VERSION)."

      - name: Lint PHP (sintassi)
        run: |
          set -euo pipefail
          find . -type f -name "*.php" -not -path "./vendor/*" -not -path "./node_modules/*" -print0 | xargs -0 -n1 php -l

      - name: Rendi eseguibile lo script di packaging
        run: chmod +x bin/package.sh

      - name: Costruisci ZIP del plugin
        id: pkg
        env:
          PLUGIN_VERSION: ${{ steps.meta.outputs.version }}
          PLUGIN_SLUG: ${{ steps.meta.outputs.slug }}
          PLUGIN_DIR: ${{ steps.meta.outputs.plugin_dir }}
        run: |
          set -euo pipefail
          bin/package.sh "$PLUGIN_SLUG" "$PLUGIN_VERSION" "$PLUGIN_DIR"
          echo "zip_path=./build/${PLUGIN_SLUG}-${PLUGIN_VERSION}.zip" >> "$GITHUB_OUTPUT"
          echo "zip_name=${PLUGIN_SLUG}-${PLUGIN_VERSION}.zip" >> "$GITHUB_OUTPUT"

      - name: Pubblica artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.pkg.outputs.zip_name }}
          path: ${{ steps.pkg.outputs.zip_path }}
          if-no-files-found: error
          retention-days: 14

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Scarica artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ format('{0}', needs.build.outputs.zip_name) }}
          path: .

      - name: Recupera artifact se nome non disponibile
        run: |
          set -euo pipefail
          ZIP="$(ls -1 *.zip 2>/dev/null | head -n1 || true)"
          if [ -z "$ZIP" ]; then
            echo "Nessun ZIP trovato per la release." >&2
            exit 1
          fi
          echo "ZIP=$ZIP" >> "$GITHUB_ENV"

      - name: Pubblica release con asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
